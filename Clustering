##clustering with daisy function a gower distance
library(cluster)
library (Rtsne)
library(ggplot2)

##sample of rows to experiment
cl_df <- cl_df[,2:8]
distances <- daisy(cl_df ,metric = "gower")

#define optimal number of clusters
avg_silhouette <- NA

for(i in 2:5){
  cluster1 <- pam(distances, diss = TRUE, k = i)
  avg_silhouette[i] <- cluster1$silinfo$avg.width
}

plot(1:10, avg_silhouette, xlab ='total number of clusters',
     ylab = 'average silhouette', bty = 'n')
lines(1:10, avg_silhouette)

#according to plot 2 cluster has the highest average silhouette, but not optimal for contracting purposes
#5 clusters closest to avg silhouette of 2 , hence choose 5 as contract number

'AB HIER ERGEBNISSE ABWARTEN JE NACH VARIABLEN'

k <- 5
final_cl <- pam(distances, diss = TRUE, k = k)
pam_results <- sample_cl %>%
  mutate(cluster = final_cl$clustering) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))

pam_results$the_summary

#visualize
install.packages("Rtsne")
tsne_obj <- Rtsne(distances, is_distance = TRUE)

#Visualize clustering
cl_df$cluster <- final_cl$clustering

#vis all cluster with repaircomplexity
visloc <- ggplot(cl_df, aes(y = `Service Location`, x = RepairComplexity, color = cluster)) + geom_point()
visprice <- ggplot(cl_df, aes(y= `Material Pricing Group Description`, x = RepairComplexity, color = cluster)) + geom_point()
visordertype <- ggplot(cl_df, aes(y= `Service Order Type`, x = RepairComplexity, color = cluster)) + geom_point()
vismainten <- ggplot(cl_df, aes(y= `Maintenance Activity Type`, x = RepairComplexity, color = cluster)) + geom_point()
visdescr <- ggplot(cl_df, aes(y= `Equipment Description`, x = RepairComplexity, color = cluster)) + geom_point()

#vis all cluster with SOperyear
vislocs <- ggplot(cl_df, aes(y = `Service Location`, x = SOperYear, colour = cluster)) + geom_point()
visprices <- ggplot(cl_df, aes(y= `Material Pricing Group Description`, x = SOperYear, color = cluster)) + geom_point()
visordertypes <- ggplot(cl_df, aes(y= `Service Order Type`, x = SOperYear, color = cluster)) + geom_point()
vismaintens <- ggplot(cl_df, aes(y= `Maintenance Activity Type`, x = SOperYear, color = cluster)) + geom_point()
visdescrs <- ggplot(cl_df, aes(y= `Equipment Description`, x = SOperYear, color = cluster)) + geom_point()


tsne_data <- tsne_obj$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(final_cl$clustering))

ggplot(aes(x = X, y = Y), data = tsne_data) +
  geom_point(aes(color = cluster))
